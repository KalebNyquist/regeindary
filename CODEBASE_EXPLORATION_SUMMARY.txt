================================================================================
REGEINDARY CODEBASE COMPREHENSIVE EXPLORATION SUMMARY
================================================================================

PROJECT: Regeindary - Standardized Registry Data Aggregation Tool
PURPOSE: Import and standardize data from heterogeneous organizational registries
         into a unified MongoDB database

CURRENT REGISTRIES SUPPORTED (4):
  1. Australia - ACNC Charity Register
  2. England and Wales - Charity Commission Register
  3. New Zealand - The Charities Register
  4. United States - IRS Exempt Organizations (Form 990s)

================================================================================
1. CODEBASE ORGANIZATION
================================================================================

Total Files: 13 (6 Python, 2 JSON schemas, 4 mapping.json, 1 TOML config)
Total Python Code: ~1,300 lines across 6 files

Directory Structure:
  /scripts/
    ├── interface.py              [102 lines] - CLI entry point (menu system)
    ├── utils.py                  [426 lines] - Database ops & utilities
    ├── config.toml               [5 lines]   - MongoDB config
    ├── Australia/
    │   ├── retrieve.py           [92 lines]
    │   └── mapping.json          [19 lines]
    ├── EnglandWales/
    │   ├── retrieve.py           [117 lines]
    │   └── mapping.json          [42 lines]
    ├── NewZealand/
    │   ├── retrieve.py           [85 lines]
    │   └── mapping.json          [23 lines]
    └── UnitedStates/
        ├── retrieve.py           [503 lines]
        └── mapping.json          [47 lines]
  
  /schemas/
    ├── entity.json               [91 lines] - Entity/Organization schema
    └── filing.json               [68 lines] - Filing schema

================================================================================
2. KEY ARCHITECTURAL COMPONENTS
================================================================================

ENTRY POINT: interface.py
  - Interactive CLI menu with 6 main operations
  - [1] Status Check
  - [2] Retrieve Registries (country selection)
  - [3] Keyword Match Assist (verify mappings)
  - [4] Match Filings with Entities
  - [5] Display Random Entity
  - Lazy imports: only loads selected country module

CORE BUSINESS LOGIC: utils.py
  - All MongoDB operations (CRUD)
  - Configuration management
  - Cache handling
  - Field mapping application
  - Entity-filing relationship matching
  - Database indexing
  - Status reporting

COUNTRY MODULES: [Country]/retrieve.py
  - Data retrieval from external APIs
  - Local caching
  - Data parsing and standardization
  - Orchestration of metadata/upload flow
  - All follow identical structure pattern

CONFIGURATION: config.toml
  - MongoDB connection URI
  - Database and collection names
  - Simple key-value format

DATA MAPPINGS: [Country]/mapping.json
  - Field name translations (origin -> target)
  - Optional date format hints
  - Enables heterogeneous source handling

SCHEMAS: /schemas/
  - JSON Schema definitions for entities and filings
  - 13 standardized entity fields
  - 8 standardized filing fields

================================================================================
3. DATA FLOW: SOURCE TO DATABASE
================================================================================

STEP 1: User initiates retrieval
        → Selects country via interface.py menu

STEP 2: Retrieve raw data
        → Country's retrieve.py downloads from API/web
        → Saves to local cache (CSV/JSON)
        → Converts to list of dictionaries

STEP 3: Load metadata and mappings
        → Loads country's mapping.json
        → Gets/creates registry entry in MongoDB
        → Prompts user about old records

STEP 4: Prepare for database insertion
        → Creates static_amendment dict with registryID, registryName, legal notices
        → These fields added to ALL records from this source

STEP 5: Apply field mapping
        → For each record: map "original_field_name" -> "standardizedFieldName"
        → Preserves unmapped fields in "Original Data"

STEP 6: Insert into MongoDB
        → send_all_to_mongodb() inserts each record
        → Tracks progress (every 100 records)
        → Returns insertion results

STEP 7: Record completion timestamp
        → Marks when retrieval finished
        → Used for status monitoring

OPTIONAL STEP 8: Match filings to entities
        → run_all_match_filings() creates entity-filing links
        → Auto-creates orphan entities if needed
        → Tracks progress every 5 minutes
        → Handles Ctrl+C gracefully

================================================================================
4. DATABASE SCHEMA & COLLECTIONS
================================================================================

THREE MONGODB COLLECTIONS:

1. registries (metadata)
   - Stores information about data sources
   - Fields: _id, name, source, download_completion
   - Purpose: Track which registries exist and when updated

2. organizations (entities)
   - Stores standardized organization records
   - 13 standard fields: entityId, entityName, websiteUrl, registeredDate, etc.
   - Added fields: registryID, registryName, legalNotices, Original Data
   - Indexes: (registryID, entityId), (registryID, entityIndex)

3. filings (annual reports)
   - Stores standardized filing records
   - 8 standard fields: filingId, startDate, endDate, totalIncome, etc.
   - Added fields: registryID, entityId_mongo (post-matching)
   - Indexes: (registryID, entityId)

STANDARDIZED FIELD PATTERNS:
  Identity:      entityId, entityName, entityIndex, subsidiaryId
  Dates:         registeredDate, establishedDate, startDate, endDate, recordDate
  Relationships: registryID, registryName, entityId_mongo
  Metadata:      legalNotices, Original Data, sourceData
  Financial:     totalIncome, totalExpenditures

================================================================================
5. REGISTRIES DETAILS
================================================================================

AUSTRALIA
  Source Type:    CSV via data.gov.au
  Entities:       YES
  Filings:        NO
  Fields Mapped:  4 (entityName, websiteUrl, entityId, establishedDate)
  Special Needs:  Custom encoding error handling
  License:        Creative Commons Attribution 3.0 Australia
  Data Method:    Direct pandas read_csv + cache

ENGLAND & WALES
  Source Type:    Two JSON files (zipped) from Azure Blob Storage
  Entities:       YES (publicextract.charity.json)
  Filings:        YES (publicextract.charity_annual_return_history.json)
  Fields Mapped:  10 (identity, dates, financial)
  Special Needs:  UTF-8-sig encoding, dual dataset handling
  License:        None specific (UK government data)
  Data Method:    Download ZIP -> Extract -> Parse JSON

NEW ZEALAND
  Source Type:    CSV via OData API (charities.govt.nz)
  Entities:       YES
  Filings:        NO
  Fields Mapped:  5 (entityName, websiteUrl, entityId, entityIndex, registeredDate)
  Special Needs:  low_memory=False, anti-spam legal notice
  License:        Unsolicited Electronic Messages Act 2007
  Data Method:    HTTP GET -> StringIO -> pandas CSV

UNITED STATES
  Source Type:    4 regional CSV files + metadata CSV (Giving Tuesday DataCommons)
  Entities:       YES (EO BMF - IRS data)
  Filings:        YES (Form 990 metadata)
  Fields Mapped:  11 (comprehensive - identity, dates, financial, web)
  Special Needs:  Multi-region concatenation, ID padding (9-digit with zeros)
  License:        Database Contents License (DbCL) v1.0
  Data Method:    Download 4 CSVs -> Concatenate -> Cache -> Parse
  Features:       Web scraping capability, AWS S3 optional access, tqdm progress bars
  Complexity:     Most complex (503 lines)

================================================================================
6. CONVENTIONS & CODING PATTERNS
================================================================================

NAMING CONVENTIONS:
  - Global variables:   UPPER_SNAKE_CASE (api_retrieval_point, registry_name)
  - Functions:          snake_case (retrieve_data, send_to_mongodb)
  - Schema fields:      camelCase (entityName, registryID)
  - Collections:        lowercase plural (organizations, filings, registries)

CODE STRUCTURE (every country retrieve.py):
  1. Imports (relative, with sys.path setup for IDE compatibility)
  2. Globals (API URLs, metadata, headers)
  3. Helper functions (if any)
  4. retrieve_data(folder) - downloads & caches source
  5. run_everything(folder) - orchestrates flow
  6. if __name__ == '__main__' block

PATTERNS:
  - Caching: check_for_cache() -> prompt user -> load/download -> save
  - Mapping: JSON array of {origin, target, format?}
  - Progress: Every 100 records during uploads, every 5 mins during matching
  - Legal: Always include legalNotices array (compliance requirement)
  - Errors: Graceful Ctrl+C handling, status code checks, encoding handling

COMMON UTILITIES (all in utils.py):
  - get_config(): Load TOML configuration
  - get_mongo_dbs(): Initialize MongoDB connection
  - check_for_cache(): Cache existence check + user prompt
  - retrieve_mapping(): Load and parse mapping.json
  - send_to_mongodb(): Single record insertion
  - send_all_to_mongodb(): Batch insertion with tracking
  - meta_check(): Get/create registry metadata
  - match_filing(): Link filing to organization
  - run_all_match_filings(): Batch matching with progress
  - status_check(): Database statistics and monitoring
  - keyword_match_assist(): Verify mapping coverage

================================================================================
7. DEPENDENCIES & REQUIREMENTS
================================================================================

PYTHON: 3.11+ (uses tomllib module)

CORE PACKAGES:
  - pymongo          - MongoDB driver
  - pandas           - CSV/data manipulation
  - requests         - HTTP operations
  - beautifulsoup4   - HTML parsing (US web scraping only)
  - tqdm             - Progress bars (US only)
  - zipfile-deflate64 - ZIP extraction (US only)
  - boto3            - AWS S3 access (optional, US filings alternative)

EXTERNAL SERVICES:
  - MongoDB locally: mongodb://127.0.0.1:27017/
  - Data APIs:
    * Australia: data.gov.au CSV endpoint
    * EnglandWales: Azure Blob Storage (zipped JSON)
    * NewZealand: charities.govt.nz OData API
    * UnitedStates: IRS website (CSV) + Giving Tuesday DataCommons (metadata)

================================================================================
8. TESTING & VALIDATION FEATURES
================================================================================

BUILT-IN TESTING (via interface.py):

1. Status Check (Menu [1])
   - Count registries, organizations, filings
   - Show completion timestamps
   - Display registry coverage percentages
   - Report total database size

2. Keyword Match Assist (Menu [3])
   - Show which schema fields are mapped (✅)
   - Show which schema fields are NOT mapped (⬜)
   - Useful for identifying incomplete mappings
   - Displays random entity for inspection

3. Random Entity Display (Menu [5])
   - Retrieve random organization
   - Show all fields including Original Data
   - Option to hide Original Data for clean view
   - Hard limit to prevent excessive queries

4. Caching Strategy
   - First run: downloads and saves cache
   - Subsequent: asks user to use cache or redownload
   - Allows iterative testing without network requests

================================================================================
9. IMPORTANT QUIRKS & SPECIAL CONSIDERATIONS
================================================================================

DATA QUALITY ISSUES:

1. Orphan Filings
   - Some filings have no matching organization
   - Auto-created from filing data (breadcrumb metadata added)
   - Expected behavior, not an error

2. Entity ID Formatting
   - US requires padding: .rjust(9, '0')
   - Comment indicates "import error with USA Data" workaround
   - Should be fixed in source eventually

3. Duplicate Matches
   - 0 matches: auto-create organization
   - 1 match: link filing to organization
   - 2+ matches: raise exception (data quality issue)

REGISTRY-SPECIFIC QUIRKS:

1. Australia
   - Custom encoding error handling required
   - Only entity records (no filings)

2. EnglandWales
   - Works better with entityIndex for matching (not entityId)
   - Two separate datasets (entities + filings)
   - Dual upload process needed

3. NewZealand
   - Requires low_memory=False for pandas
   - Legal notice about email anti-spam law (prominent warning)

4. UnitedStates
   - Most complex: 4 regional files must be concatenated
   - Custom zipfile_deflate64 import (unusual)
   - Web scraping for Form 990 files (fragile)
   - Windows-specific paths in some functions (\\ backslashes)
   - Optional S3 bucket access for alternative data source

CODE DESIGN DECISIONS:

1. Global Variables in utils.py
   - Pros: Simple access throughout
   - Cons: Requires config.toml to exist for import to succeed

2. Star Imports in retrieve.py
   - Makes all utils functions available without prefix
   - Works because interface.py imports from same package

3. Manual Field Mapping (vs ORM)
   - Pro: Explicit control over data transformation
   - Pro: Handles heterogeneous sources perfectly
   - Con: Requires human maintenance for each registry

4. Lazy Imports (country modules)
   - Pro: Fast startup, only load needed code
   - Con: Import errors only caught at runtime

================================================================================
10. DEVELOPER GUIDELINES
================================================================================

TO ADD A NEW REGISTRY:

1. Create /scripts/[Country]/ directory
2. Create retrieve.py with retrieve_data() and run_everything()
3. Create mapping.json with field mappings
4. Add legal notice in run_everything()
5. Update interface.py menu and retrieval_registries()
6. Test with built-in tools:
   - Status Check
   - Keyword Match Assist
   - Random Entity Display

CHECKLIST:
  [ ] retrieve_data() implemented
  [ ] run_everything() orchestrates flow
  [ ] mapping.json complete
  [ ] Legal notices included
  [ ] interface.py updated
  [ ] Cache handling working
  [ ] Progress tracking implemented
  [ ] Original Data preserved
  [ ] Tested with Status Check
  [ ] Tested with Keyword Match Assist

CODE REVIEW POINTS:
  - All unique identifiers correctly mapped?
  - Date formats handled properly?
  - Encoding issues addressed?
  - Cache cleanup proper?
  - Legal notices included?
  - Exceptional cases handled (orphans, duplicates)?

================================================================================
11. RECENT DEVELOPMENT HISTORY
================================================================================

Recent Commits (as of Nov 15, 2025):
  - Merge pull request #3: Optimization improvements
  - Minor improvements during match filings process
  - Merge pull request #2: Optimization improvements
  - Deleted file (cleanup)
  - Improved batch monitoring + termination speed for run_all_match_filings()
  - Added comma-separated formatting to large numbers
  - Made batch size runs accessible from interface.py

Scaling Improvements:
  - Recent optimization of run_all_match_filings() for speed
  - Better termination speed improvements
  - Progress tracking every 5 minutes
  - Handles large US dataset (500k+ records)

================================================================================
12. CRITICAL PATHS IN THE CODEBASE
================================================================================

PATH 1 - Data Retrieval:
  interface.py (menu_select)
    → retrieve_registries() 
    → Country/retrieve.py (run_everything)
    → retrieve_data() + send_all_to_mongodb()
    → MongoDB storage

PATH 2 - Filing Matching:
  interface.py (menu_select)
    → utils.run_all_match_filings()
    → match_filing()
    → MongoDB update (entityId_mongo field)

PATH 3 - Status Monitoring:
  interface.py (menu_select)
    → utils.status_check()
    → MongoDB aggregations & counts
    → Terminal output with statistics

PATH 4 - Mapping Validation:
  interface.py (menu_select)
    → utils.keyword_match_assist()
    → Load schemas & mappings
    → Compare coverage
    → Display random entity

================================================================================
13. QUICK REFERENCE FOR COMMON TASKS
================================================================================

Task                          Location
-------                       --------
Add menu option               interface.py (lines 55-96)
Change MongoDB connection     config.toml + utils.py get_mongo_dbs()
Add field mapping            Country/mapping.json
Modify data retrieval        Country/retrieve.py
Change field standardization  schemas/entity.json or schemas/filing.json
Add entity-filing logic      utils.py match_filing()
View all registries          utils.py list_registries()
Add legal notice             Country/retrieve.py run_everything()
Track progress               utils.py send_all_to_mongodb()
Handle encoding issues       Country/retrieve.py retrieve_data()

================================================================================
14. ABSOLUTE FILE PATHS (FOR REFERENCE)
================================================================================

/home/user/regeindary/scripts/interface.py
/home/user/regeindary/scripts/utils.py
/home/user/regeindary/scripts/config.toml
/home/user/regeindary/scripts/Australia/retrieve.py
/home/user/regeindary/scripts/Australia/mapping.json
/home/user/regeindary/scripts/EnglandWales/retrieve.py
/home/user/regeindary/scripts/EnglandWales/mapping.json
/home/user/regeindary/scripts/NewZealand/retrieve.py
/home/user/regeindary/scripts/NewZealand/mapping.json
/home/user/regeindary/scripts/UnitedStates/retrieve.py
/home/user/regeindary/scripts/UnitedStates/mapping.json
/home/user/regeindary/schemas/entity.json
/home/user/regeindary/schemas/filing.json

================================================================================
END OF COMPREHENSIVE CODEBASE EXPLORATION
================================================================================
